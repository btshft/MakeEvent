@model MakeEvent.Web.Models.Common.EventWithTicketsMvcViewModel

<div class="events-wrapper">
    <div class="row">
        <div class="col-md-6">
            <div class="card hoverable">
                @if (Model.ImageData != null && Model.ImageData.Length > 0)
                {
                    <img src="data:@Model.ImageMimeType;base64,@Convert.ToBase64String(Model.ImageData)" style="max-height: 400px; max-width: 400px;" />
                }
                <div class="card-content">
                    <label class="event-title">@Html.DisplayFor(m => Model.Name)</label>
                    <p class="event-date">@Html.DisplayFor(m => Model.StartDate) - @Html.DisplayFor(m => Model.EndDate)</p>
                    <p class="event-adress">
                        @Html.DisplayFor(m => Model.City)
                        @Html.DisplayFor(m => Model.Street)
                        @Html.DisplayFor(m => Model.Office)
                    </p>
                    <p class="event-description">@Html.DisplayFor(m => Model.Description)</p>
                </div>
            </div>
        </div>
        @if (Model.Tickets != null)
        {
            <div class="tickets col-md-5">
                <div class="card hoverable">
                    <h5>@Localization.HeaderTicketsText</h5>
                    <div class="card-content">
                        <table class="table table-striped">
                            <tr>
                                <th>@Localization.TicketCategoryVmType</th>
                                <th>@Localization.TicketCategoryVmDescription</th>
                                <th>@Localization.TicketCategoryVmPrice</th>
                            </tr>
                            @foreach (var item in Model.Tickets)
                            {
                                <tr>
                                    <td>
                                        @Html.DisplayNameFor(model => item.Type)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => item.Description)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => item.Price)
                                    </td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@if (ViewBag.TicketTypes != null)
{
    <button class="btn buy blue darken-3">@Localization.BtnBuyTicketText</button>

    <form id="createForm" method="POST" action="https://demomoney.yandex.ru/quickpay/confirm.xml">
        <div class="form-horizontal ticketform" style="margin-top: 20px;">
            <input id="label" name="label" value="0" type="hidden">
            <input name="receiver" value="4100324078426" type="hidden">
            <input name="formcomment" value="Оплата билета" type="hidden"/>
            <input name="quickpay-form" value="shop" type="hidden">
            <input name="targets" value="Оплата билета" type="hidden">
            <input name="paymentType" value="PC" type="hidden"/>
            <div class="form-group">
                @Html.LabelFor(model => model.Ticket.OwnerFirstName, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.EditorFor(model => model.Ticket.OwnerFirstName, new { htmlAttributes = new { @class = "form-control" } })
                    @Html.ValidationMessageFor(model => model.Ticket.OwnerFirstName, "", new { @class = "text-danger" })
                </div>
            </div>
            <div class="form-group">
                @Html.LabelFor(model => model.Ticket.OwnerLastName, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.EditorFor(model => model.Ticket.OwnerLastName, new { htmlAttributes = new { @class = "form-control" } })
                    @Html.ValidationMessageFor(model => model.Ticket.OwnerLastName, "", new { @class = "text-danger" })
                </div>
            </div>
            <div class="form-group">
                @Html.LabelFor(model => model.Ticket.CategoryId, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.DropDownListFor(model => model.Ticket.CategoryId, ViewBag.TicketTypes as SelectList, new { @class = "form-control" })
                </div>
            </div>
            <div class="form-group">
                <label for="sum" class="control-label col-md-2">Сумма</label>
                <div class="col-md-10">
                    <input id="sum" name="sum" class="form-control" value="" readonly="readonly">
                </div>
            </div>
            <input type="hidden" name="paymentType" value="PC">
            <div class="form-group">
                <div class="col-md-offset-2 col-md-10">
                    <a href="javascript:submitTicketForm();" class="btn btn-default blue darken-3">@Localization.BtnBuyTicketText</a>
                </div>
            </div>
        </div>
    </form>
}
else
{
    <p>На данное мероприятие пока что нельзя записаться.</p>
}
<script type="text/javascript">

    function updatePrice(ticketSelect) {
        $.getJSON("@Url.Action("GetTicketPrice", "Ticket")" + "?ticketCategoryId=" + ticketSelect.val(),
            function (data) { $("#sum").attr('value', data.data); });
    }

    function setLabelValue() {
        var firstName = $("#Ticket_OwnerFirstName").val();
        var lastName = $("#Ticket_OwnerLastName").val();
        var categoryId = $("#Ticket_CategoryId").val();

        $("#label").val(categoryId + "-" + lastName + "-" + firstName);
    }

    function submitTicketForm() {
        setLabelValue();
        $("#createForm").submit();
    }

    $(document).ready(function () {
        $('.ticketform').hide();
        $('.buy').click(function () {
            if ($('.ticketform').css('display') == 'none') {
                $('.ticketform').show();
            }
            else {
                $('.ticketform').hide();
            }
        });

        $("#Ticket_CategoryId").change(function () {
            updatePrice($(this));
        });

        updatePrice($("#Ticket_CategoryId"));
    });
</script>
